<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Monitoramento - Câmeras ao Vivo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body>
    <header class="dashboard-header">
        <div class="dashboard-container">
            <div class="header-content">
                <h1>Sistema de Monitoramento Digital</h1>
                <div class="header-actions">
                    <button class="btn btn-success" onclick="mostrarModalAdicionar()">Adicionar Câmera</button>
                </div>
            </div>
        </div>
    </header>

        <!-- Área Principal de Câmeras -->
        <div class="main-camera-area">
            <div id="camera-grid" class="camera-mosaic">
                {% for cam in cameras_db %}
                <div class="camera-mosaic-item" data-id="{{ cam.cam_id }}">
                    <!-- Camera Header com Status -->
                    <div class="camera-mosaic-header">
                        <div class="camera-title">
                            <h4>{{ cam.nome }}</h4>
                            <small class="camera-id">ID: {{ cam.cam_id }}</small>
                        </div>
                        <div class="camera-status">
                            {% if cam.cam_id in cameras_ativas.get('cameras', []) %}
                            <span class="status-indicator status-online">● ONLINE</span>
                            {% else %}
                            <span class="status-indicator status-offline">● OFFLINE</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Camera Stream/Video -->
                    <div class="camera-mosaic-stream">
                        {% if cam.cam_id in cameras_ativas.get('cameras', []) %}
                        <img src="{{ url_for('video_feed', camera_id=cam.cam_id) }}?t={{ now().timestamp() }}" alt="Transmissão ao vivo" class="camera-stream">
                        <div class="detection-overlay" id="detection-{{ cam.cam_id }}"></div>
                        <div class="detection-info">
                            <span id="detection-count-{{ cam.cam_id }}" class="detection-badge">0 pessoas</span>
                        </div>
                        {% else %}
                        <div class="camera-placeholder">
                            <div class="placeholder-content">
                                <span class="camera-icon">CAM</span>
                                <p>Câmera Offline</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Camera Controls -->
                    <div class="camera-mosaic-controls">
                        {% if cam.cam_id not in cameras_ativas.get('cameras', []) %}
                        <button class="btn btn-success btn-sm" onclick="iniciarCamera('{{ cam.cam_id }}')" title="Iniciar câmera">
                            Iniciar
                        </button>
                        {% else %}
                        <button class="btn btn-warning btn-sm" onclick="pararCamera('{{ cam.cam_id }}')" title="Parar câmera">
                            Parar
                        </button>
                        {% endif %}
                        <button class="btn btn-danger btn-sm" onclick="removerCamera('{{ cam.cam_id }}')" title="Remover câmera">
                            Remover
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>

            {% if not cameras_db %}
            <div class="empty-state" style="text-align: center; padding: 60px 20px;">
                <div class="empty-content">
                    <h3 style="color: #a1a1aa; margin: 20px 0 10px 0;">Nenhuma câmera configurada</h3>
                    <p style="color: #71717a; margin-bottom: 30px;">Adicione sua primeira câmera para começar o monitoramento com detecção de pessoas</p>
                    <button class="btn btn-primary" onclick="mostrarModalAdicionar()" style="font-size: 16px; padding: 12px 24px;">Adicionar Primeira Câmera</button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <footer class="dashboard-footer">
        <p>Sistema de Monitoramento com Detecção de Pessoas | YOLOv8</p>
    </footer>

    <!-- Modal para Adicionar Câmera -->
    <div id="add-camera-modal" class="modal">
        <div class="modal-overlay" onclick="fecharModalAdicionar()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-section">
                    <h3>Adicionar Nova Câmera</h3>
                </div>
                <button class="modal-close" onclick="fecharModalAdicionar()" title="Fechar">&times;</button>
            </div>
            <div class="modal-body">
                <form id="camera-form" onsubmit="adicionarCamera(event)">
                    <div class="form-section">
                        <h4>Informações Básicas</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cam_id">
                                    ID da Câmera
                                    <span class="required">*</span>
                                </label>
                                <input type="text" id="cam_id" name="cam_id" required placeholder="cam1" class="form-input">
                                <div class="field-hint">Identificador único da câmera (ex: cam1, entrada, sala01)</div>
                            </div>
                            <div class="form-group">
                                <label for="nome">
                                    Nome da Câmera
                                    <span class="required">*</span>
                                </label>
                                <input type="text" id="nome" name="nome" required placeholder="Câmera Entrada Principal" class="form-input">
                                <div class="field-hint">Nome descritivo para identificação</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>Configuração de Conexão</h4>
                        <div class="form-group">
                            <label for="url">
                                URL RTSP
                                <span class="required">*</span>
                            </label>
                            <input type="url" id="url" name="url" required placeholder="rtsp://usuario:senha@192.168.1.100:554/stream" class="form-input">
                            <div class="field-hint">Endereço completo do stream RTSP da câmera IP</div>
                            <div class="field-examples">
                                <strong>Exemplos:</strong>
                                <code>rtsp://admin:senha123@192.168.1.100:554/onvif1</code><br>
                                <code>rtsp://usuario@192.168.0.50:8554/live</code>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>Notificações</h4>
                        <div class="form-group">
                            <label for="cameraEmail">
                                E-mail para Alertas
                            </label>
                            <input type="email" id="cameraEmail" name="email_alerta" placeholder="admin@empresa.com" class="form-input">
                            <div class="field-hint">E-mail onde serão enviados os alertas de detecção</div>
                        </div>
                    </div>


                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="fecharModalAdicionar()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-success" id="submit-btn">
                            Adicionar Câmera
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

   <script>
    function mostrarModalAdicionar() {
        const modal = document.getElementById('add-camera-modal');
        modal.style.display = 'flex';
        // Focar no primeiro campo
        setTimeout(() => {
            document.getElementById('cam_id').focus();
        }, 100);
    }

    function fecharModalAdicionar() {
        const modal = document.getElementById('add-camera-modal');
        modal.style.display = 'none';
        document.getElementById('camera-form').reset();
        clearValidationErrors();
    }

    async function adicionarCamera(event) {
        event.preventDefault();

        // Limpar validações anteriores
        clearValidationErrors();

        const formData = new FormData(event.target);
        const data = {
            cam_id: formData.get('cam_id'),
            nome: formData.get('nome'),
            url: formData.get('url'),
            receiver_email: formData.get('email_alerta') || 'admin@example.com'
        };

        // Validação dos campos obrigatórios
        let isValid = true;
        const errors = [];

        if (!data.cam_id || data.cam_id.trim().length === 0) {
            showValidationError('cam_id', 'ID da câmera é obrigatório');
            isValid = false;
        } else if (!/^[a-zA-Z0-9_-]+$/.test(data.cam_id)) {
            showValidationError('cam_id', 'ID deve conter apenas letras, números, _ ou -');
            isValid = false;
        }

        if (!data.nome || data.nome.trim().length === 0) {
            showValidationError('nome', 'Nome da câmera é obrigatório');
            isValid = false;
        } else if (data.nome.trim().length < 3) {
            showValidationError('nome', 'Nome deve ter pelo menos 3 caracteres');
            isValid = false;
        }

        if (!data.url || data.url.trim().length === 0) {
            showValidationError('url', 'URL RTSP é obrigatória');
            isValid = false;
        } else if (!isValidRTSPUrl(data.url)) {
            showValidationError('url', 'URL RTSP inválida (deve começar com rtsp://)');
            isValid = false;
        }

        // Validação do email se fornecido
        if (data.receiver_email && data.receiver_email.trim().length > 0) {
            if (!isValidEmail(data.receiver_email)) {
                showValidationError('cameraEmail', 'E-mail inválido');
                isValid = false;
            }
        }


        if (!isValid) {
            return;
        }

        const submitBtn = document.getElementById('submit-btn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="loading-spinner"></span> Salvando...';
        submitBtn.disabled = true;

        try {
            const response = await fetch('/api/cameras', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showSuccessMessage('Câmera adicionada com sucesso!');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                const errorData = await response.json();
                showErrorMessage('Erro ao adicionar câmera: ' + (errorData.erro || 'Erro desconhecido'));
            }
        } catch (error) {
            showErrorMessage('Erro de conexão. Verifique se os serviços estão rodando.');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    function showValidationError(fieldId, message) {
        const input = document.getElementById(fieldId);
        const formGroup = input.closest('.form-group');

        input.classList.add('error');
        input.classList.remove('success');

        // Remover erro anterior se existir
        const existingError = formGroup.querySelector('.field-error');
        if (existingError) {
            existingError.remove();
        }

        // Adicionar novo erro
        const errorDiv = document.createElement('div');
        errorDiv.className = 'field-error';
        errorDiv.textContent = message;
        formGroup.appendChild(errorDiv);
    }

    function clearValidationErrors() {
        // Limpar classes de erro/sucesso
        document.querySelectorAll('.form-input').forEach(input => {
            input.classList.remove('error', 'success');
        });

        // Remover mensagens de erro
        document.querySelectorAll('.field-error').forEach(error => {
            error.remove();
        });
    }

    function isValidRTSPUrl(url) {
        try {
            const parsedUrl = new URL(url);
            return parsedUrl.protocol === 'rtsp:';
        } catch {
            return false;
        }
    }

    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    function showSuccessMessage(message) {
        removeExistingNotifications();
        const notification = document.createElement('div');
        notification.className = 'notificacao';
        notification.innerHTML = `
            ${message}
            <button onclick="this.parentElement.remove()">×</button>
        `;
        document.body.appendChild(notification);

        // Auto-remover após 5 segundos
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    function showErrorMessage(message) {
        removeExistingNotifications();
        const notification = document.createElement('div');
        notification.className = 'notificacao notificacao-erro';
        notification.innerHTML = `
            ${message}
            <button onclick="this.parentElement.remove()">×</button>
        `;
        document.body.appendChild(notification);

        // Auto-remover após 7 segundos para erros
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 7000);
    }

    function removeExistingNotifications() {
        document.querySelectorAll('.notificacao').forEach(notif => notif.remove());
    }

async function removerCamera(camId) {
            if (!confirm('Tem certeza que deseja remover esta câmera? Esta ação não pode ser desfeita.')) return;

            try {
                // Timeout aumentado para 15 segundos para dar mais folga.
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);

                const response = await fetch('/api/cameras/' + camId, {
                    method: 'DELETE',
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Câmera removida com sucesso!');
                    location.reload();
                } else {
                    const result = await response.json();
                    alert('Erro ao remover câmera: ' + (result.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro na comunicação:', error);
                if (error.name === 'AbortError') {
                    alert('TIMEOUT: A operação demorou muito para ser concluída. Tente novamente.');
                } else {
                    alert('Erro na comunicação com o servidor: ' + error.message);
                }
            }
        }

    async function pararCamera(camId) {
        try {
            const response = await fetch('/api/cameras/' + camId + '/stop', {
                method: 'POST'
            });
            if (response.ok) {
                alert('Câmera parada com sucesso!');
                location.reload();
            } else {
                const result = await response.json();
                alert('Erro ao parar câmera: ' + (result.erro || 'Erro desconhecido'));
            }
        } catch (error) {
            alert('Erro na comunicação com o servidor.');
        }
    }

    // ===== ESTA É A FUNÇÃO CORRETA E ÚNICA QUE VOCÊ PRECISA =====
    async function iniciarCamera(camId) {
        const card = document.querySelector(`[data-id="${camId}"]`);
        const placeholder = card.querySelector('.camera-placeholder');

        if (placeholder) {
            placeholder.innerHTML = `
                <div class="placeholder-content" style="text-align: center;">
                    <span class="loading-icon" style="font-size: 48px; display: inline-block; animation: spin 1.5s linear infinite;">...</span>
                    <p style="margin: 10px 0; color: #71717a;">Iniciando conexão...</p>
                </div>`;
        }

        try {
            const response = await fetch('/api/cameras/' + camId + '/start', {
                method: 'POST'
            });

            if (response.ok) {
                // Sucesso! Apenas espera 2 segundos e recarrega a página.
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                const result = await response.json();
                alert('ERRO ao iniciar câmera:\n' + (result.erro || 'Erro desconhecido'));
                // Restaura o botão em caso de erro
                if (placeholder) {
                     placeholder.innerHTML = `
                        <div class="placeholder-content" style="text-align: center;">
                            <span class="camera-icon" style="font-size: 48px; color: #ef4444;">ERR</span>
                            <p style="margin: 10px 0; color: #71717a;">Falha ao iniciar</p>
                            <button class="btn btn-success btn-sm" onclick="iniciarCamera('${camId}')">Tentar Novamente</button>
                        </div>`;
                }
            }
        } catch (error) {
            alert('ERRO DE CONEXÃO ao iniciar câmera:\n' + error.message);
            if (placeholder) {
                 placeholder.innerHTML = `
                    <div class="placeholder-content" style="text-align: center;">
                        <span class="camera-icon" style="font-size: 48px; color: #ef4444;">ERR</span>
                        <p style="margin: 10px 0; color: #71717a;">Falha na comunicação</p>
                        <button class="btn btn-success btn-sm" onclick="iniciarCamera('${camId}')">Tentar Novamente</button>
                    </div>`;
            }
        }
    }

    async function atualizarContadoresDeDeteccao() {
        try {
            const response = await fetch('/api/events/latest');
            if (!response.ok) {
                console.error('Polling: Falha ao buscar eventos do servidor.');
                return;
            }
            
            const eventos = await response.json();
            
            // 1. Primeiro, vamos criar um mapa de contagem (ex: {'cam1': 5, 'cam2': 2})
            //    Vamos contar apenas eventos dos últimos 30 segundos.
            const agora = new Date();
            const contagemRecente = {};

            eventos.forEach(evento => {
                const eventoTimestamp = new Date(evento.timestamp + 'Z'); // Adiciona 'Z' para UTC
                const segundosAtras = (agora - eventoTimestamp) / 1000;

                // Se o evento é de uma câmera ONLINE e tem menos de 30 segundos
                if (segundosAtras < 30) {
                    const camId = evento.camera_id;
                    if (document.querySelector(`.camera-live-card[data-id="${camId}"] .status-online`)) {
                        if (!contagemRecente[camId]) {
                            contagemRecente[camId] = 0;
                        }
                        contagemRecente[camId]++;
                    }
                }
            });

            // 2. Agora, vamos atualizar a interface (o HTML)
            const todosOsContadores = document.querySelectorAll('.detection-badge');
            
            todosOsContadores.forEach(span => {
                const card = span.closest('.camera-live-card');
                const camId = card.getAttribute('data-id');
                const contadorElemento = document.getElementById(`detection-count-${camId}`);
                
                if (contagemRecente[camId]) {
                    // Câmera com deteções recentes
                    const contagem = contagemRecente[camId];
                    contadorElemento.textContent = `${contagem} PESSOA${contagem > 1 ? 'S' : ''} DETETADA${contagem > 1 ? 'S' : ''}`;
                    contadorElemento.style.background = 'rgba(220, 53, 69, 0.9)'; // Vermelho
                    contadorElemento.style.fontWeight = 'bold';
                } else {
                    // Câmera sem deteções recentes (resetar para 0)
                    contadorElemento.textContent = '0 pessoas';
                    contadorElemento.style.background = 'rgba(0, 0, 0, 0.4)'; // Resetar cor
                    contadorElemento.style.fontWeight = 'normal';
                }
            });

        } catch (error) {
            console.error('Polling Erro:', error);
        }
    }

    // --- Inicia o "polling" ---
    // Assim que a página carregar, vamos chamar a função de atualização
    // e depois configurá-la para repetir a cada 3 segundos.
    document.addEventListener('DOMContentLoaded', () => {
        atualizarContadoresDeDeteccao(); // Chama a primeira vez
        setInterval(atualizarContadoresDeDeteccao, 3000); // Repete a cada 3 segundos
    });
</script>
</body>
</html>
